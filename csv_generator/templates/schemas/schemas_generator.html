{% extends 'navbar_page_template.html' %}
{% load i18n %}
{% load static %}

{% block header %}
    <div class="row">
        <div class="col-auto mr-auto">
            <h2>{% translate 'Data sets' %}</h2>
        </div>
        <div class="col-auto">
            <form action="{% url 'process_generate' %}" method="post">
                {% csrf_token %}
                <label for="id_records_num">{% translate 'Rows:' %}</label>
                <input type="number" max="10000" id="records_num" name="records_number">
                <input hidden id="gen_schema_id" type="number" name="schema_id" value="{{ schema_id }}">
                <button type="submit" class="btn btn-success">{% translate 'Generate data' %}</button>
            </form>
        </div>
    </div>
{% endblock header %}

{% block content-main %}
    <table class="table table-bordered">
        <thead>
        <tr>
            <th scope="col">#</th>
            <th scope="col">{% translate 'Created' %}</th>
            <th scope="col">{% translate 'Status' %}</th>
            <th scope="col">{% translate 'Action' %}</th>
        </tr>
        </thead>
        <tbody id="mydiv">
        {% for generated_file in generated_files %}
            <tr>
                <th scope="row">{{ generated_file.id }}</th>
                <td>{{ generated_file.created_datetime }}</td>
                <td>
                    {% if generated_file.is_generated == False %}
                        {#{{ generated_file.id|json_script:'generated_file_id' }}#}
                        <a href="#" id="process_button_{{ generated_file.id }}" class="btn btn-secondary disabled"
                           role="button"
                           aria-disabled="true">{% translate 'Processing' %}</a>
                    {% else %}
                        <a href="#" class="btn btn-success disabled" role="button"
                           aria-disabled="true">{% translate 'Ready' %}</a>
                    {% endif %}
                </td>
                <td>
                    {#                    <a class="mx-3"#}
                    {#                       href="{% url 'data_view' generated_file_id=generated_file.id %}">{% translate 'Show' %}</a>#}
                    {% if  generated_file.file_name %}
                        <a class="mx-3"
                           href="{% url 'download' path=generated_file.file_name %}">{% translate 'Download' %}</a>
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endblock content-main %}

{% block includes-js %}
    <script>
        // websocket script
        {#console.log(window.location)#}

        const schemaId = document.getElementById('gen_schema_id').value
        const generated_files = document.querySelectorAll('*[id^="process_button_"]');
        {#const button = document.getElementById('process_button_' + generated_file_id)#}
        const wsStart = window.location.protocol === "https:" ? 'wss://' : 'ws://'
        const socket = new WebSocket(
            wsStart
            + window.location.host
            + '/ws/generator/'
            + schemaId
            + '/'
        );

        socket.onmessage = function (e) {
            let data = JSON.parse(e.data)
            console.log(data)
            console.log("message", e)
        }
        socket.onopen = function (e) {
            {#let data = JSON.parse(e.data)#}
            console.log("data: ", e.data);
            console.log('generated_files', generated_files)
            console.log('generated_file', generated_files[0].id)
            console.log('generated_file #', generated_files[0].id.substring(15))
            console.log("open", e)
        }
        socket.onerror = function (e) {
            console.log("error", e)
        }
        socket.close = function (e) {
            console.log("close", e)
        }

    </script>
{% endblock includes-js %}
